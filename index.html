<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voetbal Spelprincipes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
        }
        @media print {
            .no-print { display: none; }
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-green-50 to-blue-50">
    <div id="app" class="p-4 md:p-8">
        <div class="max-w-6xl mx-auto">
            <!-- Header -->
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-gray-800 mb-2">‚öΩ Voetbal Spelprincipes</h1>
                <p class="text-gray-600">Verzamel en stem op spelprincipes voor trainers</p>
            </div>

            <!-- Export dropdown -->
            <div class="mb-6 flex justify-center no-print">
                <div class="relative">
                    <button id="exportBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-lg font-semibold flex items-center gap-2 transition-colors">
                        üì• Exporteer
                        <span id="exportArrow">‚ñº</span>
                    </button>
                    <div id="exportMenu" class="hidden absolute top-full mt-2 bg-white rounded-lg shadow-lg overflow-hidden z-10 min-w-full">
                        <button onclick="window.exportToCSV()" class="w-full text-left px-6 py-3 hover:bg-gray-100 flex items-center gap-3 transition-colors">
                            <span>üìä</span>
                            <span>CSV (Excel)</span>
                        </button>
                        <button onclick="window.exportToJSON()" class="w-full text-left px-6 py-3 hover:bg-gray-100 flex items-center gap-3 transition-colors">
                            <span>üíæ</span>
                            <span>JSON</span>
                        </button>
                        <button onclick="window.printPDF()" class="w-full text-left px-6 py-3 hover:bg-gray-100 flex items-center gap-3 transition-colors">
                            <span>üìÑ</span>
                            <span>Print/PDF</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Categorie√´n -->
            <div id="categories" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8 no-print"></div>

            <!-- Toevoeg knop -->
            <div class="mb-6 no-print">
                <button id="addBtn" class="w-full md:w-auto bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold flex items-center justify-center gap-2 transition-colors">
                    <span>‚ûï</span>
                    <span id="addBtnText">Voeg spelprincipe toe</span>
                </button>
            </div>

            <!-- Formulier (Add/Edit) -->
            <div id="addForm" class="bg-white rounded-lg shadow-lg p-6 mb-6 hidden no-print">
                <div class="flex justify-between items-center mb-4">
                    <h3 id="formTitle" class="text-lg font-semibold text-gray-800"></h3>
                    <button id="closeForm" class="text-gray-500 hover:text-gray-700 text-2xl">‚úï</button>
                </div>
                <textarea id="principleText" placeholder="Beschrijf het spelprincipe..." class="w-full p-3 border border-gray-300 rounded-lg mb-4 min-h-24 focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                <div class="flex gap-3">
                    <button id="saveBtn" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-semibold transition-colors">
                        Opslaan
                    </button>
                    <button id="cancelBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-6 py-2 rounded-lg font-semibold transition-colors">
                        Annuleren
                    </button>
                </div>
            </div>

            <!-- Principes lijst -->
            <div id="principlesList" class="space-y-4"></div>

            <!-- Footer info -->
            <div class="mt-12 text-center text-sm text-gray-600 bg-white rounded-lg p-4 shadow no-print">
                <p class="mb-2">üí° <strong>Tip:</strong> Data wordt gedeeld met alle gebruikers. Stem op principes die je waardevol vindt!</p>
                <p>Totaal aantal principes: <strong id="totalCount">0</strong></p>
            </div>

            <!-- Loading -->
            <div id="loading" class="text-center text-xl text-gray-600 py-12">
                <div class="animate-pulse">Laden...</div>
            </div>

            <!-- Error -->
            <div id="error" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
                <strong>Fout:</strong> <span id="errorMessage"></span>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // ========================================
        // üî• FIREBASE CONFIGURATIE
        // ========================================
        
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, onSnapshot, query } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDjKZXw2TbX_H2D1fhfLK_AjxK1sQs3B5o",
            authDomain: "spel-principes.firebaseapp.com",
            projectId: "spel-principes",
            storageBucket: "spel-principes.firebasestorage.app",
            messagingSenderId: "994766643734",
            appId: "1:994766643734:web:1e46d53edc56a0b5c66e8e"
        };

        // ========================================
        // APPLICATIE CODE
        // ========================================

        let app, db;
        
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            console.log('Firebase verbonden!');
        } catch (error) {
            showError('Firebase configuratie fout: ' + error.message);
            document.getElementById('loading').classList.add('hidden');
        }

        const CATEGORIES = ['Aanvallen', 'Verdedigen', 'Balverlies', 'Balverovering'];
        let principles = [];
        let activeCategory = 'Aanvallen';
        let userId = getUserId();
        let editingPrincipleId = null;

        function getUserId() {
            let id = localStorage.getItem('voetbal_user_id');
            if (!id) {
                id = 'user_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('voetbal_user_id', id);
            }
            return id;
        }

        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('error').classList.remove('hidden');
            setTimeout(() => {
                document.getElementById('error').classList.add('hidden');
            }, 5000);
        }

        // Laad data van Firebase
        async function loadData() {
            try {
                const q = query(collection(db, 'principles'));
                
                onSnapshot(q, (snapshot) => {
                    principles = [];
                    snapshot.forEach((doc) => {
                        principles.push({ id: doc.id, ...doc.data() });
                    });
                    renderCategories();
                    renderPrinciples();
                    document.getElementById('loading').classList.add('hidden');
                }, (error) => {
                    showError('Fout bij laden: ' + error.message);
                    document.getElementById('loading').classList.add('hidden');
                });
            } catch (error) {
                showError('Fout bij verbinden met database: ' + error.message);
                document.getElementById('loading').classList.add('hidden');
            }
        }

        function renderCategories() {
            const container = document.getElementById('categories');
            container.innerHTML = CATEGORIES.map(category => {
                const count = principles.filter(p => p.category === category).length;
                const isActive = category === activeCategory;
                return `
                    <button onclick="window.setActiveCategory('${category}')" 
                        class="p-4 rounded-lg font-semibold transition-all ${
                            isActive 
                                ? 'bg-green-600 text-white shadow-lg scale-105' 
                                : 'bg-white text-gray-700 hover:bg-green-50'
                        }">
                        ${category}
                        <span class="block text-sm mt-1 opacity-75">(${count})</span>
                    </button>
                `;
            }).join('');
        }

        function renderPrinciples() {
            const container = document.getElementById('principlesList');
            const filtered = principles
                .filter(p => p.category === activeCategory)
                .sort((a, b) => b.likes - a.likes);

            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="bg-white rounded-lg shadow p-8 text-center text-gray-500">
                        Nog geen spelprincipes in deze categorie. Wees de eerste om er een toe te voegen!
                    </div>
                `;
                document.getElementById('totalCount').textContent = principles.length;
                return;
            }

            container.innerHTML = filtered.map(principle => {
                const hasLiked = principle.likedBy && principle.likedBy.includes(userId);
                const isOwner = principle.createdBy === userId;
                return `
                    <div class="bg-white rounded-lg shadow-md hover:shadow-lg transition-shadow p-6">
                        <div class="flex gap-4">
                            <button onclick="window.toggleLike('${principle.id}')" 
                                class="flex flex-col items-center justify-center min-w-16 ${
                                    hasLiked ? 'text-blue-600' : 'text-gray-400 hover:text-blue-600'
                                } transition-colors no-print">
                                <span class="text-2xl">${hasLiked ? 'üëç' : 'üëçüèª'}</span>
                                <span class="text-sm font-semibold mt-1">${principle.likes || 0}</span>
                            </button>
                            <div class="flex-1">
                                <p class="text-gray-800 leading-relaxed">${escapeHtml(principle.text)}</p>
                                ${principle.likes > 0 ? `<span class="print-only text-sm text-gray-500">(${principle.likes} likes)</span>` : ''}
                            </div>
                            ${isOwner ? `
                                <div class="flex gap-2 no-print">
                                    <button onclick="window.editPrinciple('${principle.id}')" 
                                        class="text-blue-500 hover:text-blue-700 transition-colors self-start"
                                        title="Bewerken">
                                        <span class="text-xl">‚úèÔ∏è</span>
                                    </button>
                                    <button onclick="window.deletePrinciple('${principle.id}')" 
                                        class="text-red-500 hover:text-red-700 transition-colors self-start"
                                        title="Verwijderen">
                                        <span class="text-xl">üóëÔ∏è</span>
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('totalCount').textContent = principles.length;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        window.setActiveCategory = function(category) {
            activeCategory = category;
            renderCategories();
            renderPrinciples();
            document.getElementById('addBtnText').textContent = `Voeg spelprincipe toe aan ${category}`;
        }

        window.toggleLike = async function(principleId) {
            const principle = principles.find(p => p.id === principleId);
            if (!principle) return;

            const likedBy = principle.likedBy || [];
            const hasLiked = likedBy.includes(userId);
            
            const newLikes = hasLiked ? (principle.likes || 0) - 1 : (principle.likes || 0) + 1;
            const newLikedBy = hasLiked 
                ? likedBy.filter(id => id !== userId)
                : [...likedBy, userId];

            try {
                const principleRef = doc(db, 'principles', principleId);
                await updateDoc(principleRef, {
                    likes: newLikes,
                    likedBy: newLikedBy
                });
            } catch (error) {
                showError('Fout bij liken: ' + error.message);
            }
        }

        window.editPrinciple = function(principleId) {
            const principle = principles.find(p => p.id === principleId);
            if (!principle) return;

            editingPrincipleId = principleId;
            document.getElementById('principleText').value = principle.text;
            document.getElementById('formTitle').textContent = `Bewerk principe: ${principle.category}`;
            document.getElementById('addForm').classList.remove('hidden');
            document.getElementById('principleText').focus();
        }

        window.deletePrinciple = async function(principleId) {
            if (!confirm('Weet je zeker dat je dit spelprincipe wilt verwijderen?')) {
                return;
            }

            try {
                const principleRef = doc(db, 'principles', principleId);
                await deleteDoc(principleRef);
            } catch (error) {
                showError('Fout bij verwijderen: ' + error.message);
            }
        }

        async function savePrinciple() {
            const text = document.getElementById('principleText').value.trim();
            if (!text) return;

            try {
                if (editingPrincipleId) {
                    // Update existing
                    const principleRef = doc(db, 'principles', editingPrincipleId);
                    await updateDoc(principleRef, {
                        text: text,
                        updatedAt: new Date().toISOString()
                    });
                } else {
                    // Add new
                    const principle = {
                        category: activeCategory,
                        text: text,
                        likes: 0,
                        likedBy: [],
                        createdBy: userId,
                        createdAt: new Date().toISOString()
                    };
                    await addDoc(collection(db, 'principles'), principle);
                }
                
                closeForm();
            } catch (error) {
                showError('Fout bij opslaan: ' + error.message);
            }
        }

        function closeForm() {
            document.getElementById('principleText').value = '';
            document.getElementById('addForm').classList.add('hidden');
            editingPrincipleId = null;
        }

        // Export functions
        window.exportToCSV = function() {
            closeExportMenu();
            let csv = 'Categorie,Spelprincipe,Likes\n';
            principles
                .sort((a, b) => b.likes - a.likes)
                .forEach(p => {
                    const text = p.text.replace(/"/g, '""');
                    csv += `"${p.category}","${text}",${p.likes || 0}\n`;
                });
            
            downloadFile(csv, 'spelprincipes.csv', 'text/csv');
        }

        window.exportToJSON = function() {
            closeExportMenu();
            const data = principles.map(p => ({
                category: p.category,
                text: p.text,
                likes: p.likes || 0
            })).sort((a, b) => b.likes - a.likes);
            
            downloadFile(JSON.stringify(data, null, 2), 'spelprincipes.json', 'application/json');
        }

        window.printPDF = function() {
            closeExportMenu();
            window.print();
        }

        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type: type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Event listeners
        function setupEventListeners() {
            // Export dropdown toggle
            document.getElementById('exportBtn').addEventListener('click', (e) => {
                e.stopPropagation();
                const menu = document.getElementById('exportMenu');
                const arrow = document.getElementById('exportArrow');
                if (menu.classList.contains('hidden')) {
                    menu.classList.remove('hidden');
                    arrow.textContent = '‚ñ≤';
                } else {
                    menu.classList.add('hidden');
                    arrow.textContent = '‚ñº';
                }
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', () => {
                closeExportMenu();
            });

            document.getElementById('addBtn').addEventListener('click', () => {
                editingPrincipleId = null;
                document.getElementById('formTitle').textContent = `Nieuw principe: ${activeCategory}`;
                document.getElementById('addForm').classList.remove('hidden');
                document.getElementById('principleText').focus();
            });

            document.getElementById('closeForm').addEventListener('click', closeForm);
            document.getElementById('cancelBtn').addEventListener('click', closeForm);
            document.getElementById('saveBtn').addEventListener('click', savePrinciple);

            document.getElementById('principleText').addEventListener('keydown', (e) => {
                if (e.ctrlKey && e.key === 'Enter') {
                    savePrinciple();
                }
            });
        }

        function closeExportMenu() {
            const menu = document.getElementById('exportMenu');
            const arrow = document.getElementById('exportArrow');
            menu.classList.add('hidden');
            arrow.textContent = '‚ñº';
        }

        if (db) {
            setupEventListeners();
            loadData();
        }
    </script>
</body>
</html>
